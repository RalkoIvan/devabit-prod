var app=angular.module("twitterApp",["ngRoute","ngAnimate","ngCookies","base64","ngResource"]);app.config(["$routeProvider","$locationProvider",function(e,r){e.when("/",{templateUrl:"partials/main.html",controller:"mainCtrl",controllerAs:"vm"}).when("/login",{templateUrl:"partials/login.html",controller:"loginCtrl",controllerAs:"vm"}).when("/register",{templateUrl:"partials/registration.html",controller:"registrationCtrl",controllerAs:"vm"}).when("/add-post",{templateUrl:"partials/addPost.html",controller:"addPostCtrl",controllerAs:"vm"}).when("/people",{templateUrl:"partials/people.html",controller:"peopleCtrl",controllerAs:"vm"}).when("/people-online",{templateUrl:"partials/peopleOnline.html",controller:"peopleOnlineCtrl",controllerAs:"vm"}).when("/post-page/:postId",{templateUrl:"partials/postPage.html",controller:"postPageCtrl",controllerAs:"vm"}).otherwise({redirectTo:"/login"}),r.hashPrefix("")}]),app.controller("addPostCtrl",["$location","$rootScope","PostService","$base64",function(e,r,t,o){var n=this;n.user=o.decode(r.userCookie.currentUser.userId),n.createPost=function(){t.CreatePost(n.user,n.text).then(function(r){"success"===r&&e.path("/")})}}]),app.controller("homeCtrl",["$location","$rootScope","$cookies","$http","$base64",function(e,r,t,o,n){function s(){r.$on("$locationChangeStart",function(o,n,s){r.userCookie=t.getObject("userCookie")||{};var c=r.userCookie.currentUser;!1===["/login","/register"].includes(e.path())&&!c&&e.path("/login")})}s()}]),app.controller("loginCtrl",["$location","LoginService","RestService","UserService",function(e,r,t,o){var n=this;o.GetAll().then(function(e){e.length||t.Users.query().$promise.then(function(e){o.SetAll(e)})}),function(){r.ClearCredentials()}(),n.login=function(){r.Login(n.username,n.password,function(t){t.success?(r.SetCredentials(n.username,n.password),e.path("/")):n.logError=t.message})}}]),app.controller("mainCtrl",["RestService","PostService","UserService","$rootScope","$base64",function(e,r,t,o,n){function s(e,t){r.SetLike(e,t).then(function(e){"success"===e&&(l(),i())})}function c(e,t){r.UnLike(e,t).then(function(e){"success"===e&&(l(),i())})}function i(){r.GetAll().then(function(t){t.length?r.GetByUserId().then(function(e){u.currentUserPosts=e,console.log(u.currentUserPosts),l()}):e.Posts.query().$promise.then(function(e){r.SetAll(e),r.GetByUserId().then(function(e){u.currentUserPosts=e,l()})})})}function l(){t.GetById(n.decode(o.userCookie.currentUser.userId)).then(function(e){u.currentUser=e,r.GetFollowedUsersPosts(u.currentUser.followsUsers,u.currentUser.id).then(function(e){var r=e.concat(u.currentUserPosts);t.GetUsersNamesByPosts(r).then(function(e){u.allVisiblePosts=e,console.log(u.allVisiblePosts)})})})}var u=this;u.like=function(e,r){r?c(u.currentUser.id,e):s(u.currentUser.id,e)},i()}]),app.controller("peopleCtrl",["UserService","$rootScope","$base64",function(e,r,t){function o(){e.GetAllExceptCurrent(s.currentUserId).then(function(e){s.users=e,console.log(s.users)})}function n(){e.GetById(s.currentUserId).then(function(e){s.currentUser=e,console.log(s.currentUser.followsUsers)})}var s=this;s.currentUserId=parseInt(t.decode(r.userCookie.currentUser.userId)),s.follow=function(r){console.log(r),e.FollowUser(r,s.currentUserId).then(function(e){n(),o()})},s.unFollow=function(r){e.UnFollowUser(r,s.currentUserId).then(function(e){n(),o()})},n(),o()}]),app.controller("peopleOnlineCtrl",["RestService","PostService","UserService","$rootScope","$base64",function(e,r,t,o,n){function s(){t.GetById(c.currentUserId).then(function(e){c.currentUser=e,console.log(c.currentUser.followsUsers),t.GetSeveralById(c.currentUser.followsUsers).then(function(e){c.followedUsers=e,console.log(c.followedUsers)})})}var c=this;c.currentUserId=parseInt(n.decode(o.userCookie.currentUser.userId)),c.unFollow=function(e){t.UnFollowUser(e,c.currentUserId).then(function(e){s()})},s()}]),app.controller("postPageCtrl",["UserService","PostService","$rootScope","$base64","$routeParams",function(e,r,t,o,n){function s(t){r.GetById(t).then(function(r){c.post=r,console.log(c.post),e.GetById(c.post.user).then(function(r){c.userInfo=r,e.GetUsersByComments(c.post.comments).then(function(e){c.comments=e})})})}var c=this;c.postId=n.postId,c.currentUserId=parseInt(o.decode(t.userCookie.currentUser.userId)),s(c.postId),c.sendComment=function(e){r.SetPostComment(e,c.commentText,c.currentUserId).then(function(e){console.log(e),s(c.postId),c.commentText=""})}}]),app.controller("registrationCtrl",["$location","$rootScope","UserService",function(e,r,t){function o(){n.user.followsUsers=[],n.online=!1,t.Create(n.user).then(function(r){r.success?e.path("/login"):n.regError=r.message})}var n=this;n.register=o}]),app.factory("LoginService",["$http","$cookies","$rootScope","$base64","UserService",function(e,r,t,o,n){function s(e,r,t){var o;n.GetByUsername(e).then(function(e){o=null!==e&&e.password===r?{success:!0}:{success:!1,message:"Username or password is incorrect"},t(o)})}function c(e,t){var s=o.encode(e+":"+t);n.GetByUsername(e).then(function(t){var n=t.id,c={currentUser:{username:e,authdata:s,userId:o.encode(n)}},i=new Date;i.setDate(i.getDate()+7),r.putObject("userCookie",c,{expires:i})})}function i(){t.userCookie=null,r.remove("userCookie")}var l={};return l.Login=s,l.SetCredentials=c,l.ClearCredentials=i,l}]),app.factory("PostService",["$filter","$q","$cookies","$base64","$rootScope",function(e,r,t,o,n){function s(e){var t=r.defer();return t.resolve(m(e)),t.promise}function c(){var e=r.defer();return e.resolve(v()),e.promise}function i(e,t){var o,n=r.defer(),s=[],c=v();return e&&e.forEach(function(e){var r=c.filter(function(r){return r.user===e});r.length&&s.push(r)}),u([].concat.apply([],s),t).then(function(e){o=e,n.resolve(o)}),n.promise}function l(){var e=n.userCookie.currentUser.userId,t=parseInt(o.decode(e)),s=r.defer(),i=[];return c().then(function(e){e.forEach(function(e){e.user===t&&i.push(e)}),u(i,t).then(function(e){s.resolve(e)})}),s.promise}function u(e,t){var o=r.defer();return e.forEach(function(e){e.likedByUsers.includes(parseInt(t))&&(e.likedCurrent=!0)}),o.resolve(e),o.promise}function a(e){var t=r.defer();return c().then(function(r){var o;r.forEach(function(r){r.id===parseInt(e)&&(o=r)}),t.resolve(o)}),t.promise}function f(e,t,o){var n=r.defer();return c().then(function(r){r.forEach(function(r){if(r.id===e){var n={leftByUser:parseInt(o),commentText:t};r.comments.push(n)}}),s(r)}),n.resolve("success"),n.promise}function p(e,t){var o=r.defer();return c().then(function(r){var n=r[r.length-1]||{id:0},c={};c.id=n.id+1,c.user=parseInt(e),c.likedByUsers=[],c.comments=[],c.text=t,r.push(c),s(r),o.resolve("success")}),o.promise}function d(e,t){var o=r.defer();return c().then(function(r){r.forEach(function(r){r.id===t&&(console.log(r),r.likedByUsers.push(parseInt(e)))}),s(r),o.resolve("success")}),o.resolve("success"),o.promise}function h(e,t){var o=r.defer();return c().then(function(r){r.forEach(function(r){r.id===t&&r.likedByUsers.forEach(function(t,o){t===parseInt(e)&&r.likedByUsers.splice(o,1)})}),s(r),o.resolve("success")}),o.promise}function m(e){localStorage.posts=JSON.stringify(e)}function v(){return localStorage.posts||(localStorage.posts=JSON.stringify([])),JSON.parse(localStorage.posts)}var U={};return U.SetAll=s,U.GetAll=c,U.GetFollowedUsersPosts=i,U.GetByUserId=l,U.GetLikesByCurrentUser=u,U.GetById=a,U.SetPostComment=f,U.CreatePost=p,U.SetLike=d,U.UnLike=h,U}]),app.factory("RestService",["$resource",function(e){var r={};return r.Users=e("json/users.json",{},{query:{method:"GET",isArray:!0}}),r.Posts=e("json/posts.json",{},{query:{method:"GET",isArray:!0}}),r}]),app.factory("UserService",["$filter","$q",function(e,r){function t(e){var t=r.defer();return t.resolve(h(e)),t.promise}function o(){var e=r.defer();return e.resolve(d()),e.promise}function n(t){var o=r.defer(),n=e("filter")(d(),{id:t}),s=n.length?n[0]:null;return o.resolve(s),o.promise}function s(e){var t=r.defer(),o=[],n=d();e&&e.forEach(function(e){var r=n.filter(function(r){return r.id===e});o.push(r)});var s=[].concat.apply([],o);return t.resolve(s),t.promise}function c(t){var o=r.defer(),n=e("filter")(d(),{username:t}),s=n.length?n[0]:null;return o.resolve(s),o.promise}function i(e){var t=r.defer(),o=[];return e&&e.forEach(function(e){n(e.user).then(function(r){e.firstName=r.firstName,e.lastName=r.lastName,e.online=r.online,r&&o.push(e)})}),t.resolve(o),t.promise}function l(e){var t=r.defer();return o().then(function(r){r.forEach(function(t,o){t.id===parseFloat(e)&&r.splice(o,1)}),t.resolve(r)}),t.promise}function u(e){var t=r.defer(),o=[];return e&&e.forEach(function(e){n(e.leftByUser).then(function(r){e.firstName=r.firstName,e.lastName=r.lastName,r&&o.push(e)})}),t.resolve(o),t.promise}function a(e){var t=r.defer();return c(e.username).then(function(r){if(null!==r)t.resolve({success:!1,message:'Username "'+e.username+'" is already taken'});else{var o=d(),n=o[o.length-1]||{id:0};e.id=n.id+1,o.push(e),h(o),t.resolve({success:!0})}}),t.promise}function f(e,n){var s=r.defer();return o().then(function(r){r.forEach(function(r){r.id===n&&r.followsUsers.forEach(function(t,o){t===parseInt(e)&&r.followsUsers.splice(o,1)})}),t(r),s.resolve("success")}),s.promise}function p(e,n){var s=r.defer();return o().then(function(r){r.forEach(function(r){r.id===n&&(console.log(r),r.followsUsers.push(e))}),t(r),s.resolve("success")}),s.resolve({success:!0}),s.promise}function d(){return localStorage.users||(localStorage.users=JSON.stringify([])),JSON.parse(localStorage.users)}function h(e){localStorage.users=JSON.stringify(e)}var m={};return m.SetAll=t,m.GetAll=o,m.GetById=n,m.GetSeveralById=s,m.GetByUsername=c,m.GetUsersNamesByPosts=i,m.GetAllExceptCurrent=l,m.GetUsersByComments=u,m.Create=a,m.FollowUser=p,m.UnFollowUser=f,m}]);