var app=angular.module("twitterApp",["ngRoute","ngAnimate","ngCookies","base64","ngResource"]);app.config(["$routeProvider","$locationProvider",function(e,r){e.when("/",{templateUrl:"partials/main.html",controller:"mainCtrl",controllerAs:"vm"}).when("/login",{templateUrl:"partials/login.html",controller:"loginCtrl",controllerAs:"vm"}).when("/register",{templateUrl:"partials/registration.html",controller:"registrationCtrl",controllerAs:"vm"}).when("/add-post",{templateUrl:"partials/addPost.html",controller:"addPostCtrl",controllerAs:"vm"}).when("/people",{templateUrl:"partials/people.html",controller:"peopleCtrl",controllerAs:"vm"}).when("/people-online",{templateUrl:"partials/peopleOnline.html",controller:"peopleOnlineCtrl",controllerAs:"vm"}).when("/post-page/:postId",{templateUrl:"partials/postPage.html",controller:"postPageCtrl",controllerAs:"vm"}).otherwise({redirectTo:"/login"}),r.hashPrefix("")}]),app.controller("addPostCtrl",["$location","$rootScope","PostService","$base64",function(e,r,t,n){var o=this;o.user=n.decode(r.userCookie.currentUser.userId),o.createPost=function(){t.CreatePost(o.user,o.text).then(function(r){"success"===r&&e.path("/")})}}]),app.controller("homeCtrl",["$location","$rootScope","$cookies","$http","$base64",function(e,r,t,n,o){function s(){r.$on("$locationChangeStart",function(n,o,s){r.userCookie=t.getObject("userCookie")||{};var c=r.userCookie.currentUser;!1===["/login","/register"].includes(e.path())&&!c&&e.path("/login")})}s()}]),app.controller("loginCtrl",["$location","LoginService","RestService","UserService",function(e,r,t,n){var o=this;n.GetAll().then(function(e){e.length||t.Users.query().$promise.then(function(e){n.SetAll(e)})}),function(){r.ClearCredentials()}(),o.login=function(){r.Login(o.username,o.password,function(t){t.success?(r.SetCredentials(o.username,o.password),e.path("/")):o.logError=t.message})}}]),app.controller("mainCtrl",["RestService","PostService","UserService","$rootScope","$base64",function(e,r,t,n,o){function s(e,t){r.SetLike(e,t).then(function(e){"success"===e&&(l(),i())})}function c(e,t){r.UnLike(e,t).then(function(e){"success"===e&&(l(),i())})}function i(){r.GetAll().then(function(t){t.length?r.GetByUserId().then(function(e){u.currentUserPosts=e,l()}):e.Posts.query().$promise.then(function(e){r.SetAll(e),r.GetByUserId().then(function(e){u.currentUserPosts=e,l()})})})}function l(){t.GetById(o.decode(n.userCookie.currentUser.userId)).then(function(e){u.currentUser=e,r.GetFollowedUsersPosts(u.currentUser.followsUsers,u.currentUser.id).then(function(e){var r=e.concat(u.currentUserPosts);t.GetUsersNamesByPosts(r).then(function(e){u.allVisiblePosts=e})})})}var u=this;u.like=function(e,r){r?c(u.currentUser.id,e):s(u.currentUser.id,e)},i()}]),app.controller("peopleCtrl",["UserService","$rootScope","$base64",function(e,r,t){function n(){e.GetAllExceptCurrent(s.currentUserId).then(function(e){s.users=e})}function o(){e.GetById(s.currentUserId).then(function(e){s.currentUser=e})}var s=this;s.currentUserId=parseInt(t.decode(r.userCookie.currentUser.userId)),s.follow=function(r){e.FollowUser(r,s.currentUserId).then(function(e){o(),n()})},s.unFollow=function(r){e.UnFollowUser(r,s.currentUserId).then(function(e){o(),n()})},o(),n()}]),app.controller("peopleOnlineCtrl",["RestService","PostService","UserService","$rootScope","$base64",function(e,r,t,n,o){function s(){t.GetById(c.currentUserId).then(function(e){c.currentUser=e,t.GetSeveralById(c.currentUser.followsUsers).then(function(e){c.followedUsers=e})})}var c=this;c.currentUserId=parseInt(o.decode(n.userCookie.currentUser.userId)),c.unFollow=function(e){t.UnFollowUser(e,c.currentUserId).then(function(e){s()})},s()}]),app.controller("postPageCtrl",["UserService","PostService","$rootScope","$base64","$routeParams",function(e,r,t,n,o){function s(t){r.GetById(t).then(function(r){c.post=r,e.GetById(c.post.user).then(function(r){c.userInfo=r,e.GetUsersByComments(c.post.comments).then(function(e){c.comments=e})})})}var c=this;c.postId=o.postId,c.currentUserId=parseInt(n.decode(t.userCookie.currentUser.userId)),s(c.postId),c.sendComment=function(e){r.SetPostComment(e,c.commentText,c.currentUserId).then(function(e){s(c.postId),c.commentText=""})}}]),app.controller("registrationCtrl",["$location","$rootScope","UserService",function(e,r,t){function n(){o.user.followsUsers=[],o.online=!1,t.Create(o.user).then(function(r){r.success?e.path("/login"):o.regError=r.message})}var o=this;o.register=n}]),app.factory("LoginService",["$http","$cookies","$rootScope","$base64","UserService",function(e,r,t,n,o){function s(e,r,t){var n;o.GetByUsername(e).then(function(e){n=null!==e&&e.password===r?{success:!0}:{success:!1,message:"Username or password is incorrect"},t(n)})}function c(e,t){var s=n.encode(e+":"+t);o.GetByUsername(e).then(function(t){var o=t.id,c={currentUser:{username:e,authdata:s,userId:n.encode(o)}},i=new Date;i.setDate(i.getDate()+7),r.putObject("userCookie",c,{expires:i})})}function i(){t.userCookie=null,r.remove("userCookie")}var l={};return l.Login=s,l.SetCredentials=c,l.ClearCredentials=i,l}]),app.factory("PostService",["$filter","$q","$cookies","$base64","$rootScope",function(e,r,t,n,o){function s(e){var t=r.defer();return t.resolve(m(e)),t.promise}function c(){var e=r.defer();return e.resolve(v()),e.promise}function i(e,t){var n,o=r.defer(),s=[],c=v();return e&&e.forEach(function(e){var r=c.filter(function(r){return r.user===e});r.length&&s.push(r)}),u([].concat.apply([],s),t).then(function(e){n=e,o.resolve(n)}),o.promise}function l(){var e=o.userCookie.currentUser.userId,t=parseInt(n.decode(e)),s=r.defer(),i=[];return c().then(function(e){e.forEach(function(e){e.user===t&&i.push(e)}),u(i,t).then(function(e){s.resolve(e)})}),s.promise}function u(e,t){var n=r.defer();return e.forEach(function(e){e.likedByUsers.includes(parseInt(t))&&(e.likedCurrent=!0)}),n.resolve(e),n.promise}function a(e){var t=r.defer();return c().then(function(r){var n;r.forEach(function(r){r.id===parseInt(e)&&(n=r)}),t.resolve(n)}),t.promise}function f(e,t,n){var o=r.defer();return c().then(function(r){r.forEach(function(r){if(r.id===e){var o={leftByUser:parseInt(n),commentText:t};r.comments.push(o)}}),s(r)}),o.resolve("success"),o.promise}function p(e,t){var n=r.defer();return c().then(function(r){var o=r[r.length-1]||{id:0},c={};c.id=o.id+1,c.user=parseInt(e),c.likedByUsers=[],c.comments=[],c.text=t,r.push(c),s(r),n.resolve("success")}),n.promise}function d(e,t){var n=r.defer();return c().then(function(r){r.forEach(function(r){r.id===t&&r.likedByUsers.push(parseInt(e))}),s(r),n.resolve("success")}),n.resolve("success"),n.promise}function h(e,t){var n=r.defer();return c().then(function(r){r.forEach(function(r){r.id===t&&r.likedByUsers.forEach(function(t,n){t===parseInt(e)&&r.likedByUsers.splice(n,1)})}),s(r),n.resolve("success")}),n.promise}function m(e){localStorage.posts=JSON.stringify(e)}function v(){return localStorage.posts||(localStorage.posts=JSON.stringify([])),JSON.parse(localStorage.posts)}var U={};return U.SetAll=s,U.GetAll=c,U.GetFollowedUsersPosts=i,U.GetByUserId=l,U.GetLikesByCurrentUser=u,U.GetById=a,U.SetPostComment=f,U.CreatePost=p,U.SetLike=d,U.UnLike=h,U}]),app.factory("RestService",["$resource",function(e){var r={};return r.Users=e("json/users.json",{},{query:{method:"GET",isArray:!0}}),r.Posts=e("json/posts.json",{},{query:{method:"GET",isArray:!0}}),r}]),app.factory("UserService",["$filter","$q",function(e,r){function t(e){var t=r.defer();return t.resolve(h(e)),t.promise}function n(){var e=r.defer();return e.resolve(d()),e.promise}function o(t){var n=r.defer(),o=e("filter")(d(),{id:t}),s=o.length?o[0]:null;return n.resolve(s),n.promise}function s(e){var t=r.defer(),n=[],o=d();e&&e.forEach(function(e){var r=o.filter(function(r){return r.id===e});n.push(r)});var s=[].concat.apply([],n);return t.resolve(s),t.promise}function c(t){var n=r.defer(),o=e("filter")(d(),{username:t}),s=o.length?o[0]:null;return n.resolve(s),n.promise}function i(e){var t=r.defer(),n=[];return e&&e.forEach(function(e){o(e.user).then(function(r){e.firstName=r.firstName,e.lastName=r.lastName,e.online=r.online,r&&n.push(e)})}),t.resolve(n),t.promise}function l(e){var t=r.defer();return n().then(function(r){r.forEach(function(t,n){t.id===parseFloat(e)&&r.splice(n,1)}),t.resolve(r)}),t.promise}function u(e){var t=r.defer(),n=[];return e&&e.forEach(function(e){o(e.leftByUser).then(function(r){e.firstName=r.firstName,e.lastName=r.lastName,r&&n.push(e)})}),t.resolve(n),t.promise}function a(e){var t=r.defer();return c(e.username).then(function(r){if(null!==r)t.resolve({success:!1,message:'Username "'+e.username+'" is already taken'});else{var n=d(),o=n[n.length-1]||{id:0};e.id=o.id+1,n.push(e),h(n),t.resolve({success:!0})}}),t.promise}function f(e,o){var s=r.defer();return n().then(function(r){r.forEach(function(r){r.id===o&&r.followsUsers.forEach(function(t,n){t===parseInt(e)&&r.followsUsers.splice(n,1)})}),t(r),s.resolve("success")}),s.promise}function p(e,o){var s=r.defer();return n().then(function(r){r.forEach(function(r){r.id===o&&r.followsUsers.push(e)}),t(r),s.resolve("success")}),s.resolve({success:!0}),s.promise}function d(){return localStorage.users||(localStorage.users=JSON.stringify([])),JSON.parse(localStorage.users)}function h(e){localStorage.users=JSON.stringify(e)}var m={};return m.SetAll=t,m.GetAll=n,m.GetById=o,m.GetSeveralById=s,m.GetByUsername=c,m.GetUsersNamesByPosts=i,m.GetAllExceptCurrent=l,m.GetUsersByComments=u,m.Create=a,m.FollowUser=p,m.UnFollowUser=f,m}]);